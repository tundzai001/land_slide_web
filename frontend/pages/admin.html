<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Landslide Monitor</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/theme-variables.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>

<style>
/* ============================================
   STYLES CHO ADMIN & WIZARD
============================================ */
.sensor-config-section {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    margin-bottom: 16px;
    overflow: hidden;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from { opacity: 0; max-height: 0; transform: translateY(-10px); }
    to { opacity: 1; max-height: 500px; transform: translateY(0); }
}

.sensor-config-header {
    background: rgba(14, 165, 233, 0.08);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
}

.sensor-config-body { padding: 16px; }

.coordinate-lock-box {
    background: rgba(245, 158, 11, 0.08);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
}

.wizard-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 32px;
    position: relative;
}

.wizard-steps::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: var(--border-color);
    z-index: 0;
}

.wizard-step {
    flex: 1;
    text-align: center;
    position: relative;
    z-index: 1;
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 8px;
    transition: all 0.3s;
}

.wizard-step.active .step-circle {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
    box-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
}

.step-label { font-size: 0.85rem; color: var(--text-muted); }
.wizard-step.active .step-label { color: var(--accent-primary); font-weight: 600; }

.wizard-content { display: none; }
.wizard-content.active { display: block; animation: fadeIn 0.3s; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.btn-gradient {
    background: var(--gradient-button);
    border: none;
    color: white;
    font-weight: 600;
    transition: all 0.3s;
}
.btn-gradient:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(14, 165, 233, 0.4);
    color: white;
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--bg-secondary);
}

/* Session Time Display */
.session-time {
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    font-weight: 700;
    letter-spacing: 1px;
}
</style>

    <!-- Sidebar -->
    <div class="admin-sidebar">
        <div class="sidebar-brand">
            <h4><i class="bi bi-shield-lock-fill me-2"></i>Admin Panel</h4>
            <small class="text-muted">Landslide Monitor</small>
        </div>

        <nav>
            <div class="nav-item">
                <a class="nav-link" href="/pages/map.html">
                    <i class="bi bi-map"></i>
                    <span>Bản đồ</span>
                </a>
            </div>
            <div class="nav-item">
                <a class="nav-link active" href="/pages/admin.html">
                    <i class="bi bi-gear-fill"></i>
                    <span>Quản lý Hệ thống</span>
                </a>
            </div>
            <div class="nav-item mt-5">
                <a class="nav-link text-danger" href="#" id="logout-btn">
                    <i class="bi bi-box-arrow-left"></i>
                    <span>Đăng xuất</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Top Navbar -->
    <nav class="admin-navbar">
        <div class="d-flex justify-content-between align-items-center w-100">
            <div class="navbar-left">
                <span class="text-muted small">Time (UTC+7):</span>
                <span class="fw-bold ms-2 session-time" id="current-time" style="color: var(--accent-primary);">--:--:--</span>
            </div>
            <div class="navbar-right d-flex align-items-center gap-3">
                <div class="theme-toggle-mini" id="theme-toggle" onclick="window.themeManager.toggle()">
                    <i class="bi bi-moon-stars-fill"></i>
                </div>
                <div class="user-profile d-flex align-items-center gap-2">
                    <div class="avatar-circle">A</div>
                    <span class="d-none d-sm-block">Administrator</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="admin-main">
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-gear-wide-connected me-2"></i>
                Quản lý Hệ thống
            </h1>
            <p class="text-muted">Quản lý người dùng, dự án và database</p>
        </div>

        <!-- Main Tabs -->
        <ul class="nav nav-tabs main-tabs" id="mainTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-users">
                    <i class="bi bi-people me-2"></i>Người dùng
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-projects">
                    <i class="bi bi-folder me-2"></i>Dự án
                </button>
            </li>
            <li class="nav-item">   
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-database">
                    <i class="bi bi-database me-2"></i>Database
                </button>
            </li>
            <li class="nav-item" id="system-tab" style="display: none;">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-system">
                    <i class="bi bi-cpu me-2"></i>Hệ thống
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            
            <!-- TAB 1: USERS -->
            <div class="tab-pane fade show active" id="tab-users">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4>Danh sách Người dùng</h4>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="bi bi-person-plus me-2"></i>Thêm user
                    </button>
                </div>

                <div class="custom-table">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tài khoản</th>
                                <th>Họ tên</th>
                                <th>Vai trò</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-2 text-muted">Đang tải...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 2: PROJECTS -->
            <div class="tab-pane fade" id="tab-projects">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb" id="project-breadcrumb">
                        <li class="breadcrumb-item active">Dự án</li>
                    </ol>
                </nav>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-outline-secondary" id="btn-back-nav" style="display: none;" onclick="window.adminManager.navigateBack()">
                            <i class="bi bi-arrow-left me-1"></i> Quay lại
                        </button>
                        <h4 id="current-view-title" class="mb-0">Danh sách Dự án</h4>
                    </div>
                    <div id="action-buttons-container">
                        <button class="btn btn-gradient" onclick="window.adminManager.openCreateProjectModal()">
                            <i class="bi bi-plus-circle me-2"></i>Tạo Dự án
                        </button>
                    </div>
                </div>

                <div id="projects-content-area">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                        <p class="text-muted mt-2">Đang tải...</p>
                    </div>
                </div>
            </div>

            <!-- TAB 3: DATABASE -->
            <div class="tab-pane fade" id="tab-database">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="bi bi-database me-2"></i>Quản lý Database</h4>
                    
                    <!-- UPDATED BUTTONS -->
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="window.dbManager.loadAllData()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                        
                        <!-- EXCEL EXPORT -->
                        <button class="btn btn-outline-success" onclick="window.dbManager.exportToExcel()">
                            <i class="bi bi-file-earmark-excel me-1"></i>Export Excel
                        </button>
                        
                        <!-- CLEAR DATABASE -->
                        <button class="btn btn-outline-danger" onclick="window.dbManager.clearDatabase()">
                            <i class="bi bi-trash3 me-1"></i>Xóa DB
                        </button>
                    </div>
                </div>

                <!-- Filter & Search -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" id="db-filter-table" onchange="window.dbManager.applyFilter()">
                                    <option value="all">Tất cả bảng</option>
                                    <option value="stations">Stations</option>
                                    <option value="devices">Devices</option>
                                    <option value="sensor_data">Sensor Data</option>
                                    <option value="alerts">Alerts</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="db-search" placeholder="Tìm kiếm..." oninput="window.dbManager.applyFilter()">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="db-limit" onchange="window.dbManager.applyFilter()">
                                    <option value="50">50 dòng</option>
                                    <option value="100" selected>100 dòng</option>
                                    <option value="500">500 dòng</option>
                                    <option value="1000">1000 dòng</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database Viewer -->
                <div class="custom-table" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-hover table-sm mb-0">
                        <thead id="db-table-head" class="sticky-top">
                            <tr>
                                <th style="width: 80px;">ID</th>
                                <th style="width: 120px;">Table</th>
                                <th>Data Preview</th>
                                <th style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="db-table-body">
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="spinner-border text-primary"></div>
                                    <p class="mt-2 text-muted">Đang tải...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Stats -->
                <div class="row g-3 mt-3">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h6 class="mb-1">Stations</h6>
                                <h3 id="stat-stations" class="mb-0">--</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h6 class="mb-1">Devices</h6>
                                <h3 id="stat-devices" class="mb-0">--</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h6 class="mb-1">Sensor Data</h6>
                                <h3 id="stat-data" class="mb-0">--</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <h6 class="mb-1">Active Alerts</h6>
                                <h3 id="stat-alerts" class="mb-0">--</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ✅ THÊM TAB 4: HỆ THỐNG -->
            <div class="tab-pane fade" id="tab-system">
                
                <!-- ⚠️ Warning Header -->
                <div class="alert alert-danger mb-4">
                    <div class="d-flex align-items-center gap-3">
                        <i class="bi bi-shield-exclamation fs-1"></i>
                        <div>
                            <h5 class="mb-1"><strong>CẢNH BÁO:</strong> Cài đặt toàn hệ thống</h5>
                            <p class="mb-0">Thay đổi ở đây sẽ ảnh hưởng tới <strong>TẤT CẢ</strong> trạm giám sát. Hãy cẩn thận!</p>
                        </div>
                    </div>
                </div>

                <form id="systemConfigForm">

                    <!-- 1. MQTT Configuration -->
                    <div class="config-section">
                        <div class="section-header">
                            <i class="bi bi-hdd-network-fill"></i>
                            <h5>MQTT Broker Configuration</h5>
                            <span class="badge bg-success ms-auto">CONNECTED</span>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="bi bi-server me-1"></i> Broker Address
                                </label>
                                <input type="text" class="form-control" id="sys-mqtt-broker" placeholder="aitogy.click">
                                <small class="text-muted">Địa chỉ MQTT Broker (IP hoặc Domain)</small>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="bi bi-plug me-1"></i> Port
                                </label>
                                <input type="number" class="form-control" id="sys-mqtt-port" value="1883">
                                <small class="text-muted">Mặc định: 1883</small>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Reload Interval
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="sys-reload-interval" value="60">
                                    <span class="input-group-text">giây</span>
                                </div>
                                <small class="text-muted">Tần suất reload topics</small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="bi bi-person-badge me-1"></i> Username
                                </label>
                                <input type="text" class="form-control" id="sys-mqtt-user" placeholder="mqttUser">
                                <small class="text-muted">Tài khoản MQTT</small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="bi bi-key-fill me-1"></i> Password
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="sys-mqtt-password" placeholder="••••••••">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('sys-mqtt-password')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Mật khẩu MQTT</small>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Alert Confirmation Settings -->
                    <div class="config-section">
                        <div class="section-header">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <h5>Cơ chế Đếm Xác Nhận Cảnh Báo</h5>
                            <span class="badge bg-warning text-dark ms-auto">CRITICAL</span>
                        </div>

                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <strong>Cơ chế đếm xác nhận:</strong> Hệ thống sẽ chỉ gửi cảnh báo khi phát hiện vượt ngưỡng <strong>liên tục N lần</strong> (tránh false alarm)
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="bi bi-geo-alt-fill text-danger me-1"></i> GNSS
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="sys-confirm-gnss" value="3" min="1" max="10">
                                    <span class="input-group-text">lần</span>
                                </div>
                                <small class="text-muted">Số lần xác nhận GNSS</small>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="bi bi-cloud-rain-fill text-primary me-1"></i> Rain
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="sys-confirm-rain" value="2" min="1" max="10">
                                    <span class="input-group-text">lần</span>
                                </div>
                                <small class="text-muted">Số lần xác nhận Mưa</small>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="bi bi-water text-info me-1"></i> Water
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="sys-confirm-water" value="3" min="1" max="10">
                                    <span class="input-group-text">lần</span>
                                </div>
                                <small class="text-muted">Số lần xác nhận Nước</small>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="bi bi-activity text-warning me-1"></i> IMU
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="sys-confirm-imu" value="1" min="1" max="5">
                                    <span class="input-group-text">lần</span>
                                </div>
                                <small class="text-muted">Shock thường báo ngay</small>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Data Save Intervals -->
                    <div class="config-section">
                        <div class="section-header">
                            <i class="bi bi-clock-history"></i>
                            <h5>Chu Kỳ Lưu Database</h5>
                            <span class="badge bg-info ms-auto">DATABASE</span>
                        </div>

                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <strong>Chu kỳ lưu DB:</strong> Để tránh quá tải, dữ liệu chỉ lưu vào DB theo chu kỳ. Khi có cảnh báo, sẽ lưu ngay lập tức.
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="bi bi-geo-alt-fill text-danger me-1"></i> GNSS
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="sys-save-gnss" value="86400">
                                    <span class="input-group-text">giây</span>
                                </div>
                                <small class="text-muted">Mặc định: 86400s (1 ngày)</small>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="bi bi-cloud-rain-fill text-primary me-1"></i> Rain
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="sys-save-rain" value="3600">
                                    <span class="input-group-text">giây</span>
                                </div>
                                <small class="text-muted">Mặc định: 3600s (1 giờ)</small>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="bi bi-water text-info me-1"></i> Water
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="sys-save-water" value="3600">
                                    <span class="input-group-text">giây</span>
                                </div>
                                <small class="text-muted">Mặc định: 3600s (1 giờ)</small>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="bi bi-activity text-warning me-1"></i> IMU
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="sys-save-imu" value="2592000">
                                    <span class="input-group-text">giây</span>
                                </div>
                                <small class="text-muted">Mặc định: 2592000s (30 ngày)</small>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Quick Presets -->
                    <div class="config-section">
                        <div class="section-header">
                            <i class="bi bi-lightning-charge-fill"></i>
                            <h5>Quick Presets</h5>
                        </div>
                        
                        <div class="row g-2">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-primary w-100" onclick="window.systemManager.applyPreset('conservative')">
                                    <i class="bi bi-shield-check me-2"></i>
                                    Conservative (Ít cảnh báo sai)
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-warning w-100" onclick="window.systemManager.applyPreset('balanced')">
                                    <i class="bi bi-sliders me-2"></i>
                                    Balanced (Cân bằng)
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-danger w-100" onclick="window.systemManager.applyPreset('sensitive')">
                                    <i class="bi bi-exclamation-diamond me-2"></i>
                                    Sensitive (Nhạy cảm)
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="text-end">
                        <button type="button" class="btn btn-lg btn-danger" onclick="window.systemManager.saveSystemConfig()">
                            <i class="bi bi-save me-2"></i> Lưu cấu hình toàn hệ thống
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- ============================================
         MODALS
    ============================================ -->

    <!-- 1. Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm người dùng mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label class="form-label">Tài khoản</label>
                            <input type="text" class="form-control" id="new-username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mật khẩu</label>
                            <input type="password" class="form-control" id="new-password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Họ tên</label>
                            <input type="text" class="form-control" id="new-fullname">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vai trò</label>
                            <select class="form-select" id="new-role">
                                <option value="viewer">Viewer</option>
                                <option value="operator">Operator</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-gradient" onclick="window.adminManager.createUser()">Tạo tài khoản</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Create Project Modal -->
    <div class="modal fade" id="createProjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tạo Dự án Mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createProjectForm">
                        <div class="mb-3">
                            <label class="form-label">Mã dự án <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="project-code" required>
                            <small class="text-muted">VD: DA_QUANGNINH_2024</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tên dự án <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="project-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control" id="project-desc" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vị trí</label>
                            <input type="text" class="form-control" id="project-location" placeholder="VD: Quảng Ninh">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-gradient" onclick="window.adminManager.createProject()">
                        <i class="bi bi-save me-1"></i> Tạo Dự án
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Station Config Modal - 3 STEPS WIZARD -->
    <div class="modal fade" id="stationConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">Cấu hình Trạm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Wizard Steps UI -->
                    <div class="wizard-steps" id="wizard-steps">
                        <div class="wizard-step active" data-step="1">
                            <div class="step-circle">1</div>
                            <div class="step-label">Thông tin cơ bản</div>
                        </div>
                        <div class="wizard-step" data-step="2">
                            <div class="step-circle">2</div>
                            <div class="step-label">MQTT & Tọa độ</div>
                        </div>
                        <div class="wizard-step" data-step="3">
                            <div class="step-circle">3</div>
                            <div class="step-label">Ngưỡng cảnh báo</div>
                        </div>
                    </div>

                    <form id="stationConfigForm">
                        <input type="hidden" id="edit-station-id">
                        <input type="hidden" id="edit-project-id">
                        
                        <!-- STEP 1: MÃ TRẠM & TÊN -->
                        <div class="wizard-content active" data-step="1">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Mã trạm <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="edit-code" required>
                                    <small class="text-muted">VD: ST01, ST02...</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Tên trạm <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="edit-name" required>
                                    <small class="text-muted">VD: Trạm Đà Nẵng</small>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 2: MQTT & TỌA ĐỘ -->
                        <div class="wizard-content" data-step="2">
                            <div class="alert alert-info small mb-3">
                                <i class="bi bi-info-circle me-1"></i>
                                Chọn thiết bị → Nhập MQTT Topic → Cấu hình tọa độ (nếu cần)
                            </div>

                            <h6 class="mb-3">1. Chọn thiết bị cần kích hoạt:</h6>
                            <div class="d-flex flex-wrap gap-3 mb-4 p-3 border rounded">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="edit-gnss">
                                    <label class="form-check-label"><i class="bi bi-geo-alt-fill text-danger me-1"></i> GNSS</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="edit-rain">
                                    <label class="form-check-label"><i class="bi bi-cloud-rain-fill me-1" style="color: var(--accent-primary);"></i> Rain</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="edit-water">
                                    <label class="form-check-label"><i class="bi bi-water me-1" style="color: var(--accent-info);"></i> Water</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="edit-imu">
                                    <label class="form-check-label"><i class="bi bi-compass-fill me-1" style="color: var(--accent-warning);"></i> IMU</label>
                                </div>
                            </div>

                            <h6 class="mb-3">2. Cấu hình MQTT Topics:</h6>

                            <div id="mqtt-gnss-section" class="sensor-config-section" style="display: none;">
                                <div class="sensor-config-header">
                                    <i class="bi bi-geo-alt-fill text-danger"></i>
                                    <span>GNSS Configuration</span>
                                </div>
                                <div class="sensor-config-body">
                                    <label class="form-label">MQTT Topic</label>
                                    <input type="text" class="form-control mb-3" id="topic-gnss" placeholder="station/ST01/gnss">
                                    
                                    <div class="coordinate-lock-box">
                                        <h6 class="mb-2"><i class="bi bi-crosshair me-2"></i>Khóa Tọa độ Gốc (Origin)</h6>
                                        <div class="row g-2 mb-3">
                                            <div class="col-md-4"><label class="form-label small">Lat</label><input type="number" step="0.00000001" class="form-control form-control-sm" id="origin-lat" readonly></div>
                                            <div class="col-md-4"><label class="form-label small">Lon</label><input type="number" step="0.00000001" class="form-control form-control-sm" id="origin-lon" readonly></div>
                                            <div class="col-md-4"><label class="form-label small">Height</label><input type="number" step="0.001" class="form-control form-control-sm" id="origin-h" readonly></div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small id="origin-status" class="text-muted">Chưa có dữ liệu gốc</small>
                                            <button type="button" class="btn btn-sm btn-warning" id="btn-fetch-origin" onclick="window.adminManager.fetchLatestOrigin()">
                                                <i class="bi bi-arrow-repeat me-1"></i> Lấy tọa độ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="mqtt-rain-section" class="sensor-config-section" style="display: none;">
                                <div class="sensor-config-header"><i class="bi bi-cloud-rain-fill text-primary"></i><span>Rain Configuration</span></div>
                                <div class="sensor-config-body"><label class="form-label">MQTT Topic</label><input type="text" class="form-control" id="topic-rain"></div>
                            </div>
                            <div id="mqtt-water-section" class="sensor-config-section" style="display: none;">
                                <div class="sensor-config-header"><i class="bi bi-water text-info"></i><span>Water Configuration</span></div>
                                <div class="sensor-config-body"><label class="form-label">MQTT Topic</label><input type="text" class="form-control" id="topic-water"></div>
                            </div>
                            <div id="mqtt-imu-section" class="sensor-config-section" style="display: none;">
                                <div class="sensor-config-header"><i class="bi bi-compass-fill text-warning"></i><span>IMU Configuration</span></div>
                                <div class="sensor-config-body"><label class="form-label">MQTT Topic</label><input type="text" class="form-control" id="topic-imu"></div>
                            </div>

                            <div id="mqtt-empty-state" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1"></i>
                                <p class="mt-2">Chưa có thiết bị nào được chọn</p>
                            </div>
                        </div>

                        <!-- STEP 3: NGƯỠNG -->
                        <div class="wizard-content" data-step="3">
                            <h6 class="mb-2 text-primary"><i class="bi bi-water me-2"></i>Water & Displacement</h6>
                            <div class="row g-3 mb-4 p-3 border rounded bg-light">
                                <div class="col-md-6"><label class="form-label">Warning (m)</label><input type="number" step="0.01" class="form-control" id="cfg-water-warning" value="0.15"></div>
                                <div class="col-md-6"><label class="form-label">Critical (m)</label><input type="number" step="0.01" class="form-control" id="cfg-water-critical" value="0.30"></div>
                            </div>

                            <h6 class="mb-2 text-info"><i class="bi bi-cloud-rain me-2"></i>Rain (mm/h)</h6>
                            <div class="row g-3 mb-4 p-3 border rounded bg-light">
                                <div class="col-md-4"><label class="form-label">Watch</label><input type="number" class="form-control" id="cfg-rain-watch" value="10.0"></div>
                                <div class="col-md-4"><label class="form-label">Warning</label><input type="number" class="form-control" id="cfg-rain-warning" value="25.0"></div>
                                <div class="col-md-4"><label class="form-label">Critical</label><input type="number" class="form-control" id="cfg-rain-critical" value="50.0"></div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="text-danger mb-0"><i class="bi bi-geo-alt me-2"></i>GNSS Quality</h6>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="window.adminManager.openVelocityModal()">Bảng vận tốc</button>
                            </div>
                            <div class="row g-3 mb-4 p-3 border rounded bg-light">
                                <div class="col-md-6"><label class="form-label">Max HDOP</label><input type="number" step="0.1" class="form-control" id="cfg-gnss-hdop" value="4.0"></div>
                                <div class="col-md-6"><label class="form-label">Confirm Steps</label><input type="number" class="form-control" id="cfg-gnss-steps" value="3"></div>
                                <div class="col-md-6"><label class="form-label">Safe Streak</label><input type="number" class="form-control" id="cfg-gnss-streak" value="5"></div>
                                <div class="col-md-6"><label class="form-label">Degraded Timeout (s)</label><input type="number" class="form-control" id="cfg-gnss-timeout" value="300"></div>
                            </div>

                            <h6 class="mb-2 text-warning"><i class="bi bi-activity me-2"></i>IMU Shock</h6>
                            <div class="row g-3 p-3 border rounded bg-light">
                                <div class="col-md-6"><label class="form-label">Shock Threshold (m/s²)</label><input type="number" step="0.1" class="form-control" id="cfg-imu-shock" value="5.0"></div>
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-danger" onclick="window.adminManager.deleteStation(window.adminManager.currentStationId)" id="btn-delete-station" style="display: none;">
                        <i class="bi bi-trash"></i> Xóa trạm
                    </button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" id="btn-wizard-back" style="display: none;" onclick="window.adminManager.wizardPrev()">
                            <i class="bi bi-arrow-left me-1"></i> Quay lại
                        </button>
                        <button type="button" class="btn btn-primary" id="btn-wizard-next" onclick="window.adminManager.wizardNext()">
                            Tiếp theo <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                        <button type="button" class="btn btn-success" id="btn-wizard-save" style="display: none;" onclick="window.adminManager.saveStation()">
                            <i class="bi bi-save me-1"></i> Lưu cấu hình
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Modal Velocity Config -->
    <div class="modal fade" id="velocityConfigModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-speedometer2 me-2"></i>Phân cấp Vận tốc (Cruden & Varnes)</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="window.adminManager.closeVelocityModal()"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="alert alert-light m-3 border">
                        <small class="text-muted"><i class="bi bi-info-circle-fill me-1"></i> Bảng phân cấp vận tốc trượt. Bạn có thể sửa ngưỡng (threshold) và nhấn "Áp dụng".</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 25%">Cấp độ (Name)</th>
                                    <th style="width: 25%">Ngưỡng (mm/s)</th>
                                    <th>Mô tả / Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody id="velocity-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="window.adminManager.closeVelocityModal()">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="window.adminManager.applyVelocityConfig()">
                        <i class="bi bi-check-lg me-1"></i> Áp dụng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Edit Database Record Modal -->
    <div class="modal fade" id="editRecordModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Table</label>
                        <input type="text" class="form-control" id="edit-table" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Record ID</label>
                        <input type="text" class="form-control" id="edit-id" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">JSON Data</label>
                        <textarea class="form-control" id="edit-json" rows="15" style="font-family: 'Courier New', monospace; font-size: 0.9rem;"></textarea>
                        <small class="text-muted">Chỉnh sửa JSON, sau đó bấm Save</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="window.dbManager.saveRecord()">
                        <i class="bi bi-save me-1"></i>Lưu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="password-shield" class="password-shield" style="display: none;">
        <div class="password-dialog">
            <h4><i class="bi bi-shield-lock-fill me-2"></i>SYSTEM ACCESS</h4>
            <p class="subtitle">
                Nhập System Password để truy cập<br>
                cài đặt toàn hệ thống
            </p>
            
            <div class="mb-3">
                <input 
                    type="password" 
                    class="form-control" 
                    id="system-password-input" 
                    placeholder="••••" 
                    maxlength="20"
                    autofocus
                >
            </div>
            
            <!-- Hint box -->
            <div id="password-hint" class="password-hint" style="display: none;"></div>
            
            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-secondary flex-1" onclick="window.systemManager.cancelPasswordCheck()">
                    <i class="bi bi-x-circle me-1"></i> Hủy
                </button>
                <button class="btn btn-danger flex-1" onclick="window.systemManager.verifyPassword()">
                    <i class="bi bi-unlock me-1"></i> Xác nhận
                </button>
            </div>
            
            <!-- Error message -->
            <p class="text-center mt-3 mb-0 small" id="password-error" style="display: none; color: var(--accent-danger);">
                <i class="bi bi-exclamation-triangle-fill me-1"></i> 
                <span id="error-message">Sai mật khẩu!</span>
            </p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/theme-manager.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/toast-notifications.js"></script>
    <script src="/js/admin-manager.js"></script>
    <script src="/js/db-manager.js"></script>
    <script src="/js/system-manager.js"></script>
    
    <script>
        // TIME (UTC+7)
        function updateSystemTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('vi-VN', {
                timeZone: 'Asia/Ho_Chi_Minh',
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const timeEl = document.getElementById('current-time');
            if (timeEl) {
                timeEl.textContent = timeStr;
            }
        }
        
        // Cập nhật mỗi giây
        setInterval(updateSystemTime, 1000);
        updateSystemTime();
    </script>

<!-- MODAL CHỌN BẢNG EXPORT EXCEL -->
<div class="modal fade" id="exportExcelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-file-earmark-excel me-2"></i>
                    Export Excel
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body">
                <p class="text-muted mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    Chọn bảng dữ liệu muốn export ra file Excel:
                </p>
                
                <!-- CHECKLIST CÁC BẢNG -->
                <div class="export-options">
                    
                    <!-- Projects -->
                    <div class="form-check export-item">
                        <input class="form-check-input" type="checkbox" id="export-projects" checked>
                        <label class="form-check-label" for="export-projects">
                            <i class="bi bi-folder-fill text-primary me-2"></i>
                            <strong>Projects</strong>
                            <small class="text-muted d-block ms-4">Danh sách dự án</small>
                        </label>
                    </div>
                    
                    <!-- Stations -->
                    <div class="form-check export-item">
                        <input class="form-check-input" type="checkbox" id="export-stations" checked>
                        <label class="form-check-label" for="export-stations">
                            <i class="bi bi-broadcast-pin text-success me-2"></i>
                            <strong>Stations</strong>
                            <small class="text-muted d-block ms-4">Thông tin trạm giám sát</small>
                        </label>
                    </div>
                    
                    <!-- Devices -->
                    <div class="form-check export-item">
                        <input class="form-check-input" type="checkbox" id="export-devices" checked>
                        <label class="form-check-label" for="export-devices">
                            <i class="bi bi-cpu text-info me-2"></i>
                            <strong>Devices</strong>
                            <small class="text-muted d-block ms-4">Thiết bị cảm biến (GNSS, Rain, Water, IMU)</small>
                        </label>
                    </div>
                    
                    <!-- Sensor Data -->
                    <div class="form-check export-item">
                        <input class="form-check-input" type="checkbox" id="export-sensor-data" checked>
                        <label class="form-check-label" for="export-sensor-data">
                            <i class="bi bi-graph-up text-warning me-2"></i>
                            <strong>Sensor Data</strong>
                            <small class="text-muted d-block ms-4">Dữ liệu cảm biến (giới hạn 10,000 records gần nhất)</small>
                        </label>
                    </div>
                    
                    <!-- Alerts -->
                    <div class="form-check export-item">
                        <input class="form-check-input" type="checkbox" id="export-alerts" checked>
                        <label class="form-check-label" for="export-alerts">
                            <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                            <strong>Alerts</strong>
                            <small class="text-muted d-block ms-4">Cảnh báo hệ thống (giới hạn 5,000 records gần nhất)</small>
                        </label>
                    </div>
                    
                </div>
                
                <!-- QUICK SELECT -->
                <div class="mt-3 pt-3 border-top">
                    <small class="text-muted">Chọn nhanh:</small>
                    <div class="btn-group btn-group-sm mt-2 w-100">
                        <button class="btn btn-outline-primary" onclick="window.dbManager.selectAllExport()">
                            <i class="bi bi-check-all me-1"></i>Tất cả
                        </button>
                        <button class="btn btn-outline-secondary" onclick="window.dbManager.deselectAllExport()">
                            <i class="bi bi-x me-1"></i>Bỏ chọn
                        </button>
                        <button class="btn btn-outline-info" onclick="window.dbManager.selectOnlyData()">
                            <i class="bi bi-database me-1"></i>Chỉ dữ liệu
                        </button>
                    </div>
                </div>
                
                <!-- WARNING -->
                <div class="alert alert-info mt-3 mb-0">
                    <small>
                        <i class="bi bi-lightning-charge me-1"></i>
                        <strong>Lưu ý:</strong> File Excel lớn có thể mất vài giây để tạo
                    </small>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i> Hủy
                </button>
                <button type="button" class="btn btn-success" onclick="window.dbManager.confirmExportExcel()">
                    <i class="bi bi-download me-1"></i> Tải xuống Excel
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Export Modal Styles */
.export-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.export-item {
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    transition: all 0.3s;
    cursor: pointer;
}

.export-item:hover {
    background: rgba(14, 165, 233, 0.05);
    border-color: var(--accent-primary);
}

.export-item .form-check-input:checked ~ .form-check-label {
    color: var(--accent-primary);
}

.export-item .form-check-input {
    width: 20px;
    height: 20px;
    margin-top: 2px;
    cursor: pointer;
}

.export-item .form-check-label {
    cursor: pointer;
    width: 100%;
    margin-left: 8px;
}

.export-item small {
    font-size: 0.8rem;
    line-height: 1.3;
}

#exportExcelModal .modal-header {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}
</style>

</body>
</html>